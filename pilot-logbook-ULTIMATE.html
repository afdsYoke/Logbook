<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pilot Logbook - ULTIMATE Edition</title>
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1e293b 100%);
            color: #e2e8f0;
            padding: 15px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        .setup-panel {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.4);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .setup-panel h2 { color: #60a5fa; margin-bottom: 15px; }
        .setup-form { display: grid; gap: 12px; margin-top: 20px; }
        .setup-input {
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            font-family: monospace;
        }
        
        .sync-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
        }
        .sync-status.connecting { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.4); }
        .sync-status.connected { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.4); }
        .sync-status.error { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.4); }
        
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(37, 99, 235, 0.4);
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        
        #app { display: none; }
        #app.ready { display: block; }
        
        .main-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .main-stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
            border-radius: 14px;
            padding: 20px;
            border-left: 5px solid;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .main-stat-card h3 { font-size: 12px; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; }
        .main-stat-card .value { font-size: 32px; font-weight: 700; font-family: 'Courier New', monospace; }
        .main-stat-card .subtext { font-size: 11px; color: #64748b; margin-top: 5px; }
        
        .buttons { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        button {
            padding: 11px 18px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-secondary { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 2px solid rgba(59, 130, 246, 0.4); }
        .btn-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 2px solid rgba(245, 158, 11, 0.4); }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 2px solid rgba(239, 68, 68, 0.4); }
        
        .card {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(51, 65, 85, 0.6);
        }
        
        .flight-row {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 15px;
            padding-right: 110px;
            margin-bottom: 12px;
            border: 1px solid rgba(51, 65, 85, 0.4);
            transition: all 0.3s;
            position: relative;
        }
        .flight-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); gap: 10px; }
        .flight-info-label { font-size: 9px; color: #64748b; margin-bottom: 2px; }
        .flight-info-value { font-size: 12px; font-weight: 600; }
        
        .action-btns {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .action-btn {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: #60a5fa;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
        }
        .action-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #f87171;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 1000;
            padding: 15px;
            overflow-y: auto;
        }
        .modal.show { display: flex; align-items: flex-start; justify-content: center; padding-top: 20px; }
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 25px;
            max-width: 900px;
            width: 100%;
            border: 1px solid rgba(51, 65, 85, 0.6);
            margin-bottom: 40px;
        }
        
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 12px; font-weight: 600; color: #94a3b8; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 11px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
        }
        .form-group textarea { min-height: 60px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .form-row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; }
        .form-section { 
            background: rgba(59, 130, 246, 0.08); 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
        }
        .form-section h3 { font-size: 15px; color: #60a5fa; margin-bottom: 12px; }
        
        .time-input-group { display: flex; gap: 6px; align-items: center; }
        .time-input { flex: 1; text-align: center; }
        .time-separator { font-size: 18px; font-weight: 700; color: #94a3b8; }
        
        .calc-display {
            background: rgba(16, 185, 129, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid #10b981;
        }
        .calc-label { font-size: 11px; color: #6ee7b7; margin-bottom: 5px; }
        .calc-value { font-size: 14px; color: #34d399; font-weight: 700; font-family: 'Courier New', monospace; }
        
        .auto-fill-btn {
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            color: #34d399;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            margin: 4px;
        }
        
        .sunrise-info {
            background: rgba(245, 158, 11, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid #f59e0b;
            font-size: 11px;
            color: #fbbf24;
        }
        
        input[type="file"] { display: none; }
        .empty-state { text-align: center; padding: 50px 20px; color: #64748b; }
        
        @media (max-width: 768px) {
            .form-row, .form-row-3, .form-row-4 { grid-template-columns: 1fr; }
            .main-stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Firebase Setup -->
        <div id="setupPanel" class="setup-panel">
            <h2>ğŸ”¥ Firebase í´ë¼ìš°ë“œ ë™ê¸°í™” ì„¤ì •</h2>
            <div class="setup-form">
                <input type="text" class="setup-input" id="apiKey" placeholder="API Key" />
                <input type="text" class="setup-input" id="projectId" placeholder="Project ID" />
                <input type="text" class="setup-input" id="appId" placeholder="App ID" />
                <button class="btn-primary" onclick="saveFirebaseConfig()">âœ… ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°</button>
                <button class="btn-danger" onclick="clearFirebaseConfig()">ğŸ—‘ï¸ ì €ì¥ëœ ì„¤ì • ì‚­ì œ</button>
            </div>
        </div>
        
        <div class="header">
            <h1>âœˆï¸ Pilot Flight Logbook - ULTIMATE</h1>
            <p>Aviation Night Rules (Sunset+1h ~ Sunrise-1h) | All Excel Fields (AG~AQ)</p>
            <div class="sync-status connecting" id="syncStatus">ğŸ”„ Firebase ì„¤ì • ëŒ€ê¸° ì¤‘...</div>
            <div id="projectInfo" style="font-size: 12px; color: #94a3b8; margin-top: 8px; display: none;">
                ğŸ“¦ í”„ë¡œì íŠ¸: <span id="currentProject"></span>
            </div>
        </div>

        <div id="app">
            <div class="main-stats">
                <div class="main-stat-card" style="border-left-color: #3b82f6;">
                    <h3>Total Block Time</h3>
                    <div class="value" style="color: #3b82f6;" id="totalBlock">0:00</div>
                    <div class="subtext" id="prevBlock">ì´ì „: 0:00</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #10b981;">
                    <h3>Total PIC</h3>
                    <div class="value" style="color: #10b981;" id="totalPIC">0:00</div>
                    <div class="subtext" id="prevPIC">ì´ì „: 0:00</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #8b5cf6;">
                    <h3>Night Time</h3>
                    <div class="value" style="color: #8b5cf6;" id="totalNight">0:00</div>
                    <div class="subtext" id="prevNight">ì´ì „: 0:00</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #f59e0b;">
                    <h3>Instrument</h3>
                    <div class="value" style="color: #f59e0b;" id="totalInst">0:00</div>
                    <div class="subtext" id="prevInst">ì´ì „: 0:00</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #ec4899;">
                    <h3>Takeoffs</h3>
                    <div class="value" style="color: #ec4899;" id="totalTO">0</div>
                    <div class="subtext" id="prevTO">ì´ì „: 0</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #06b6d4;">
                    <h3>Landings</h3>
                    <div class="value" style="color: #06b6d4;" id="totalLD">0</div>
                    <div class="subtext" id="prevLD">ì´ì „: 0</div>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-primary" onclick="showAddModal()">â• ë¹„í–‰ ì¶”ê°€</button>
                <button class="btn-secondary" onclick="document.getElementById('excelFile').click()">ğŸ“¤ ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°</button>
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="importExcel(event)" />
                <button class="btn-warning" onclick="exportExcel()">ğŸ“¥ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn-secondary" onclick="showFirebaseSettings()">âš™ï¸ Firebase ì„¤ì •</button>
                <button class="btn-secondary" onclick="showRouteModal()">ğŸ—ºï¸ ë…¸ì„  ì„¤ì •</button>
                <button class="btn-danger" onclick="resetAll()">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 18px; font-size: 19px;">ë¹„í–‰ ê¸°ë¡ (<span id="count">0</span>)</h2>
                <div id="list">
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 12px;">âœˆï¸</div>
                        <p>ë¹„í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flight Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">âœˆï¸ ìƒˆ ë¹„í–‰ ê¸°ë¡</h2>
            <form onsubmit="saveFlight(event)">
                <input type="hidden" id="editId">
                
                <div class="form-section">
                    <h3>ğŸ“… ê¸°ë³¸ ì •ë³´</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ë‚ ì§œ *</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>A/C Type *</label>
                            <input type="text" id="aircraft" placeholder="B738" required>
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>A/C Ident (ê¸°ì²´ë²ˆí˜¸)</label>
                            <input type="text" id="acIdent" placeholder="8507">
                        </div>
                        <div class="form-group">
                            <label>FLT NO</label>
                            <input type="text" id="fltNo" placeholder="594" oninput="applyRouteMapping()">
                        </div>
                        <div class="form-group">
                            <label>ì¶œë°œ * (ICAO)</label>
                            <input type="text" id="from" placeholder="RKSI" required style="text-transform: uppercase;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ë„ì°© * (ICAO)</label>
                            <input type="text" id="to" placeholder="RJAA" required style="text-transform: uppercase;">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>â›½ FUEL (ì—°ë£Œ)</h3>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>RAMP OUT (kg)</label>
                            <input type="number" id="fuelRampOut" placeholder="12000" min="0" oninput="calcFuel()">
                        </div>
                        <div class="form-group">
                            <label>RAMP IN (kg)</label>
                            <input type="number" id="fuelRampIn" placeholder="5000" min="0" oninput="calcFuel()">
                        </div>
                        <div class="form-group">
                            <label>T-RSV (kg)</label>
                            <input type="number" id="fuelTRSV" placeholder="4500" min="0" oninput="calcFuel()">
                        </div>
                    </div>
                    <div class="calc-display">
                        <div class="calc-label">ì—°ë£Œ ê³„ì‚°:</div>
                        <div class="calc-value">
                            USED: <span id="calcFuelUsed">--</span> kg | 
                            RESERVE: <span id="calcFuelReserve">--</span>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>â±ï¸ UTC ì‹œê°„ (HH:MM)</h3>
                    <div class="form-row-4">
                        <div class="form-group">
                            <label>RAMP OUT</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="rampOutH" min="0" max="23" placeholder="HH">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="rampOutM" min="0" max="59" placeholder="MM">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>TAKEOFF</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="takeoffH" min="0" max="23" placeholder="HH">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="takeoffM" min="0" max="59" placeholder="MM">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>LANDING</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="landingH" min="0" max="23" placeholder="HH">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="landingM" min="0" max="59" placeholder="MM">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>RAMP IN</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="rampInH" min="0" max="23" placeholder="HH">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="rampInM" min="0" max="59" placeholder="MM">
                            </div>
                        </div>
                    </div>
                    <div class="calc-display">
                        <div class="calc-label">ìë™ ê³„ì‚°:</div>
                        <div class="calc-value">BLOCK: <span id="calcBlock">--</span> | INST: <span id="calcInst">--</span></div>
                        <div style="margin-top: 8px;">
                            <button type="button" class="auto-fill-btn" onclick="autoFillRole('pic')">â†’ PIC</button>
                            <button type="button" class="auto-fill-btn" onclick="autoFillRole('picSupv')">â†’ PIC Supv</button>
                            <button type="button" class="auto-fill-btn" onclick="autoFillRole('coPilot')">â†’ CoPilot</button>
                            <button type="button" class="auto-fill-btn" onclick="autoFillRole('tr')">â†’ TR</button>
                        </div>
                    </div>
                    <div class="sunrise-info" id="sunriseInfo" style="display: none;">
                        <div class="calc-label">ì¼ì¶œ/ì¼ëª° ì •ë³´ (ìë™ Day/Night êµ¬ë¶„):</div>
                        <div id="sunriseText"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ‘¨â€âœˆï¸ ì—­í• ë³„ ì‹œê°„</h3>
                    <div class="form-row-4">
                        <div class="form-group">
                            <label>PIC</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="picH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="picM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>PIC Supv</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="picSupvH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="picSupvM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>CoPilot</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="coPilotH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="coPilotM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>TR</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="trH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="trM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>NIGHT</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="nightH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="nightM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>INST (ìë™)</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="instH" min="0" placeholder="ì‹œ" readonly style="background: rgba(16, 185, 129, 0.1);">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="instM" min="0" max="59" placeholder="ë¶„" readonly style="background: rgba(16, 185, 129, 0.1);">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ›¬ ì´ì°©ë¥™ & ì ‘ê·¼</h3>
                    <div class="form-group">
                        <label>APP TYPE (ì ‘ê·¼ ë°©ì‹)</label>
                        <input type="text" id="appType" placeholder="ILS 33R">
                    </div>
                    <p style="font-size: 11px; color: #94a3b8; margin-bottom: 10px;">
                        ğŸ’¡ PIC/PIC Supv ì…ë ¥ ì‹œ ìë™ 1, NightëŠ” í•­ê³µ ê·œì •(Sunset+1h) ê¸°ì¤€ìœ¼ë¡œ ìë™ êµ¬ë¶„ë©ë‹ˆë‹¤.
                    </p>
                    <div class="form-row-4">
                        <div class="form-group">
                            <label>TO Day â˜€ï¸</label>
                            <input type="number" id="toDay" placeholder="ìë™" min="0">
                        </div>
                        <div class="form-group">
                            <label>TO Night ğŸŒ™</label>
                            <input type="number" id="toNight" placeholder="ìë™" min="0">
                        </div>
                        <div class="form-group">
                            <label>LD Day â˜€ï¸</label>
                            <input type="number" id="ldDay" placeholder="ìë™" min="0">
                        </div>
                        <div class="form-group">
                            <label>LD Night ğŸŒ™</label>
                            <input type="number" id="ldNight" placeholder="ìë™" min="0">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ† Landing Score</h3>
                    <div class="form-group">
                        <label>Score (1-10)</label>
                        <input type="number" id="landingScore" placeholder="8" min="1" max="10">
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ“ ìƒì„¸ ì •ë³´</h3>
                    <div class="form-group">
                        <label>Remark (ë¹„ê³ )</label>
                        <input type="text" id="remark" placeholder="C ê¹€ì² ìˆ˜">
                    </div>
                    <div class="form-group">
                        <label>Wx Dest (ëª©ì ì§€ ê¸°ìƒ)</label>
                        <input type="text" id="wxDest" placeholder="CAVOK">
                    </div>
                    <div class="form-group">
                        <label>Landing Comment (ì°©ë¥™ í‰ê°€)</label>
                        <textarea id="landingComment" placeholder="ì™„ë²½í•œ ì°©ë¥™"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Clearance (ê´€ì œ í—ˆê°€)</label>
                        <textarea id="clearance" placeholder="RKSI DEP..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>TIP (ë©”ëª¨/íŒ)</label>
                        <textarea id="tip" placeholder="ë°”ëŒ ì£¼ì˜"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn-primary" style="flex: 1; padding: 14px;">ì €ì¥</button>
                    <button type="button" class="btn-secondary" style="flex: 1; padding: 14px;" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Route Modal -->
    <div id="routeModal" class="modal">
        <div class="modal-content">
            <h2>ğŸ—ºï¸ ë…¸ì„  ì„¤ì •</h2>
            <div id="routeList"></div>
            <button class="btn-primary" onclick="addRoute()">â• ë…¸ì„  ì¶”ê°€</button>
            <button class="btn-secondary" onclick="closeRouteModal()" style="margin-top: 10px;">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp, getApps, deleteApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        
        let db, auth, userId, flights = [], prev = {}, unsubscribe = null, routeMap = {};
        
        // âœ… ê³µí•­ ì¼ì¶œì¼ëª° ë°ì´í„°ë² ì´ìŠ¤ (ì›”ë³„ í‰ê· )
        const AIRPORT_SUN_DB = {
            'RKSI': { // ì¸ì²œ
                1:  {sunrise:'07:30',sunset:'17:30'}, 2:  {sunrise:'07:10',sunset:'18:00'},
                3:  {sunrise:'06:30',sunset:'18:30'}, 4:  {sunrise:'05:50',sunset:'19:00'},
                5:  {sunrise:'05:20',sunset:'19:30'}, 6:  {sunrise:'05:10',sunset:'19:50'},
                7:  {sunrise:'05:20',sunset:'19:45'}, 8:  {sunrise:'05:45',sunset:'19:15'},
                9:  {sunrise:'06:10',sunset:'18:30'}, 10: {sunrise:'06:40',sunset:'17:45'},
                11: {sunrise:'07:10',sunset:'17:15'}, 12: {sunrise:'07:30',sunset:'17:15'}
            },
            'RKSS': { // ê¹€í¬
                1:  {sunrise:'07:30',sunset:'17:30'}, 2:  {sunrise:'07:10',sunset:'18:00'},
                3:  {sunrise:'06:30',sunset:'18:30'}, 4:  {sunrise:'05:50',sunset:'19:00'},
                5:  {sunrise:'05:20',sunset:'19:30'}, 6:  {sunrise:'05:10',sunset:'19:50'},
                7:  {sunrise:'05:20',sunset:'19:45'}, 8:  {sunrise:'05:45',sunset:'19:15'},
                9:  {sunrise:'06:10',sunset:'18:30'}, 10: {sunrise:'06:40',sunset:'17:45'},
                11: {sunrise:'07:10',sunset:'17:15'}, 12: {sunrise:'07:30',sunset:'17:15'}
            },
            'RJAA': { // ë‚˜ë¦¬íƒ€
                1:  {sunrise:'06:45',sunset:'16:45'}, 2:  {sunrise:'06:25',sunset:'17:15'},
                3:  {sunrise:'05:45',sunset:'17:45'}, 4:  {sunrise:'05:00',sunset:'18:15'},
                5:  {sunrise:'04:30',sunset:'18:45'}, 6:  {sunrise:'04:20',sunset:'19:00'},
                7:  {sunrise:'04:30',sunset:'19:00'}, 8:  {sunrise:'05:00',sunset:'18:30'},
                9:  {sunrise:'05:25',sunset:'17:45'}, 10: {sunrise:'05:55',sunset:'17:00'},
                11: {sunrise:'06:30',sunset:'16:30'}, 12: {sunrise:'06:45',sunset:'16:30'}
            },
            'RJTT': { // í•˜ë„¤ë‹¤
                1:  {sunrise:'06:45',sunset:'16:45'}, 2:  {sunrise:'06:25',sunset:'17:15'},
                3:  {sunrise:'05:45',sunset:'17:45'}, 4:  {sunrise:'05:00',sunset:'18:15'},
                5:  {sunrise:'04:30',sunset:'18:45'}, 6:  {sunrise:'04:20',sunset:'19:00'},
                7:  {sunrise:'04:30',sunset:'19:00'}, 8:  {sunrise:'05:00',sunset:'18:30'},
                9:  {sunrise:'05:25',sunset:'17:45'}, 10: {sunrise:'05:55',sunset:'17:00'},
                11: {sunrise:'06:30',sunset:'16:30'}, 12: {sunrise:'06:45',sunset:'16:30'}
            }
        };
        
        // âœ… ê³µí•­ ì¼ì¶œì¼ëª° ê°€ì ¸ì˜¤ê¸° (DB ì‚¬ìš©)
        function getSunriseSunset(icao, date) {
            const month = new Date(date).getMonth() + 1;
            const defaultSun = { sunrise: '06:00', sunset: '18:00' };
            return AIRPORT_SUN_DB[icao]?.[month] || defaultSun;
        }
        
        // âœ… ì‹œê°„ ê³„ì‚° í—¬í¼ í•¨ìˆ˜
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }
        
        function addMinutes(timeStr, mins) {
            const totalMins = timeToMinutes(timeStr) + mins;
            const h = Math.floor(totalMins / 60) % 24;
            const m = totalMins % 60;
            return `${pad(h)}:${pad(m)}`;
        }
        
        function subtractMinutes(timeStr, mins) {
            let totalMins = timeToMinutes(timeStr) - mins;
            if (totalMins < 0) totalMins += 1440;
            const h = Math.floor(totalMins / 60) % 24;
            const m = totalMins % 60;
            return `${pad(h)}:${pad(m)}`;
        }
        
        // âœ… Night íŒë‹¨ (í•­ê³µ ê·œì •: Sunset+1h ~ Sunrise-1h)
        function isNightTime(icao, date, timeUTC) {
            if (!timeUTC) return false;
            const sunData = getSunriseSunset(icao, date);
            
            // í•­ê³µ ê·œì •: Night = Sunset+1h ~ Sunrise-1h
            const nightStart = addMinutes(sunData.sunset, 60);
            const nightEnd = subtractMinutes(sunData.sunrise, 60);
            
            const timeMin = timeToMinutes(timeUTC);
            const nightStartMin = timeToMinutes(nightStart);
            const nightEndMin = timeToMinutes(nightEnd);
            
            // Night íŒë‹¨
            return timeMin >= nightStartMin || timeMin < nightEndMin;
        }
        
        // âœ… ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function pad(n) { return String(n).padStart(2, '0'); }
        function toDisplay(dec) {
            if (!dec) return '0:00';
            const h = Math.floor(dec);
            let m = Math.round((dec - h) * 60);
            if (m === 60) return `${h + 1}:00`;
            return `${h}:${pad(m)}`;
        }
        function toDec(h, m) { return (h || 0) + (m || 0) / 60; }
        function timeStr(h, m) {
            if (!h && !m) return '';
            return `${pad(h||0)}:${pad(m||0)}`;
        }
        
        function calcTimes(rampOut, takeoff, landing, rampIn) {
            if (!rampOut || !rampIn) return { block: 0, inst: 0 };
            const toMin = (t) => {
                if (!t) return 0;
                const [h, m] = t.split(':').map(Number);
                return h * 60 + m;
            };
            const rampOutMin = toMin(rampOut);
            const rampInMin = toMin(rampIn);
            let blockMin = rampInMin - rampOutMin;
            if (blockMin < 0) blockMin += 1440;
            let instMin = 0;
            if (takeoff && landing) {
                const toMin_ = toMin(takeoff);
                const ldMin = toMin(landing);
                instMin = ldMin - toMin_;
                if (instMin < 0) instMin += 1440;
            }
            return { block: blockMin / 60, inst: instMin / 60 };
        }
        
        function setSyncStatus(status, text) {
            const el = document.getElementById('syncStatus');
            el.className = `sync-status ${status}`;
            el.textContent = text;
        }
        
        // âœ… Firebase ì´ˆê¸°í™”
        async function initFirebase(config) {
            try {
                setSyncStatus('connecting', 'ğŸ”„ ì—°ê²° ì¤‘...');
                
                if (unsubscribe) {
                    unsubscribe();
                    unsubscribe = null;
                }
                
                const existingApps = getApps();
                if (existingApps.length > 0) {
                    for (const app of existingApps) {
                        await deleteApp(app);
                    }
                }
                
                const app = initializeApp({
                    apiKey: config.apiKey,
                    authDomain: `${config.projectId}.firebaseapp.com`,
                    projectId: config.projectId,
                    storageBucket: `${config.projectId}.appspot.com`,
                    appId: config.appId
                });
                
                db = getFirestore(app);
                auth = getAuth(app);
                userId = 'pilot-logbook-user';
                await signInAnonymously(auth);
                
                await loadData();
                setupRealtimeSync();
                
                document.getElementById('setupPanel').style.display = 'none';
                document.getElementById('app').classList.add('ready');
                setSyncStatus('connected', 'â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°ë¨');
                document.getElementById('projectInfo').style.display = 'block';
                document.getElementById('currentProject').textContent = config.projectId;
                
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                setSyncStatus('error', 'âŒ ì—°ê²° ì‹¤íŒ¨');
            }
        }
        
        async function loadData() {
            const flightsRef = collection(db, 'users', userId, 'flights');
            const snapshot = await getDocs(flightsRef);
            
            flights = [];
            snapshot.forEach(d => flights.push({ id: d.id, ...d.data() }));
            
            const prevRef = doc(db, 'users', userId, 'settings', 'previous');
            const prevDoc = await getDoc(prevRef);
            if (prevDoc.exists()) prev = prevDoc.data();
            
            render(flights);
        }
        
        function setupRealtimeSync() {
            const flightsRef = collection(db, 'users', userId, 'flights');
            unsubscribe = onSnapshot(flightsRef, (snapshot) => {
                flights = [];
                snapshot.forEach(d => flights.push({ id: d.id, ...d.data() }));
                render(flights);
            });
        }
        
        async function saveFlightToFirebase(data) {
            setSyncStatus('connecting', 'ğŸ”„ ì €ì¥ ì¤‘...');
            const flightRef = doc(db, 'users', userId, 'flights', data.id);
            await setDoc(flightRef, data);
            setSyncStatus('connected', 'â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°ë¨');
        }
        
        async function savePreviousToFirebase() {
            const prevRef = doc(db, 'users', userId, 'settings', 'previous');
            await setDoc(prevRef, prev);
        }
        
        // âœ… ë Œë”ë§
        function render(list) {
            document.getElementById('count').textContent = list.length;
            
            if (list.length === 0) {
                document.getElementById('list').innerHTML = '<div class="empty-state"><div style="font-size:48px;">âœˆï¸</div><p>ë¹„í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                updateStats();
                return;
            }
            
            document.getElementById('list').innerHTML = list.slice().reverse().map(f => `
                <div class="flight-row">
                    <div class="action-btns">
                        <button class="action-btn" onclick="window.editFlight('${f.id}')">âœï¸</button>
                        <button class="action-btn delete" onclick="window.deleteFlight('${f.id}')">ğŸ—‘ï¸</button>
                    </div>
                    
                    <!-- ê¸°ë³¸ ì •ë³´ (ì´˜ì´˜í•˜ê²Œ) -->
                    <div style="display: grid; grid-template-columns: 90px 140px 70px auto; gap: 8px; margin-bottom: 6px;">
                        <div><div class="flight-info-label">ë‚ ì§œ</div><div class="flight-info-value">${f.date}</div></div>
                        <div><div class="flight-info-label">ê¸°ì²´</div><div class="flight-info-value">${f.aircraft}${f.acIdent ? ' #'+f.acIdent : ''}</div></div>
                        <div><div class="flight-info-label">FLT</div><div class="flight-info-value">${f.fltNo||'-'}</div></div>
                        <div><div class="flight-info-label">êµ¬ê°„</div><div class="flight-info-value">${f.from}â†’${f.to}</div></div>
                    </div>
                    
                    <!-- ì‹œê°„ ì •ë³´ (ì´˜ì´˜í•˜ê²Œ) -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 8px; margin-bottom: 6px;">
                        <div><div class="flight-info-label">BLOCK</div><div class="flight-info-value" style="color:#60a5fa;">${toDisplay(f.blockTime)}</div></div>
                        <div><div class="flight-info-label">PIC</div><div class="flight-info-value" style="color:#34d399;">${toDisplay(f.pic)}</div></div>
                        <div><div class="flight-info-label">INST</div><div class="flight-info-value" style="color:#fbbf24;">${toDisplay(f.instTime)}</div></div>
                        <div><div class="flight-info-label">TO</div><div class="flight-info-value" style="color:#ec4899;">â˜€ï¸${f.toDay||0}/ğŸŒ™${f.toNight||0}</div></div>
                        <div><div class="flight-info-label">LD</div><div class="flight-info-value" style="color:#06b6d4;">â˜€ï¸${f.ldDay||0}/ğŸŒ™${f.ldNight||0}</div></div>
                    </div>
                    
                    <!-- ì¶”ê°€ ì •ë³´ (ì´˜ì´˜í•˜ê²Œ) -->
                    ${(f.appType || f.landingScore || f.wxDest || f.fuelUsed) ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 6px;">
                        ${f.appType ? `<div><div class="flight-info-label">APP</div><div class="flight-info-value">${f.appType}</div></div>` : ''}
                        ${f.landingScore ? `<div><div class="flight-info-label">Score</div><div class="flight-info-value" style="color:#f59e0b;">ğŸ†${f.landingScore}</div></div>` : ''}
                        ${f.wxDest ? `<div><div class="flight-info-label">WX</div><div class="flight-info-value">${f.wxDest}</div></div>` : ''}
                        ${f.fuelUsed ? `<div><div class="flight-info-label">FUEL</div><div class="flight-info-value">${f.fuelUsed}kg</div></div>` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- ê¸´ í…ìŠ¤íŠ¸ í•„ë“œë“¤ (ë¼ë²¨: ë‚´ìš© í˜•íƒœë¡œ í•œ ì¤„ì—) -->
                    ${f.landingComment ? `
                    <div style="margin-bottom: 4px; padding: 6px 10px; background: rgba(16, 185, 129, 0.08); border-radius: 6px; font-size: 12px;">
                        <span style="color: #6ee7b7; font-weight: 600;">ğŸ’¬ ì°©ë¥™í‰ê°€:</span> <span style="color: #e2e8f0;">${f.landingComment}</span>
                    </div>
                    ` : ''}
                    
                    ${f.clearance ? `
                    <div style="margin-bottom: 4px; padding: 6px 10px; background: rgba(59, 130, 246, 0.08); border-radius: 6px; font-size: 12px;">
                        <span style="color: #93c5fd; font-weight: 600;">ğŸ“¡ Clearance:</span> <span style="color: #e2e8f0;">${f.clearance}</span>
                    </div>
                    ` : ''}
                    
                    ${f.tip ? `
                    <div style="margin-bottom: 4px; padding: 6px 10px; background: rgba(245, 158, 11, 0.08); border-radius: 6px; font-size: 12px;">
                        <span style="color: #fcd34d; font-weight: 600;">ğŸ’¡ TIP:</span> <span style="color: #e2e8f0;">${f.tip}</span>
                    </div>
                    ` : ''}
                    
                    ${f.remark ? `
                    <div style="margin-bottom: 4px; padding: 6px 10px; background: rgba(139, 92, 246, 0.08); border-radius: 6px; font-size: 12px;">
                        <span style="color: #c4b5fd; font-weight: 600;">ğŸ“ Remark:</span> <span style="color: #e2e8f0;">${f.remark}</span>
                    </div>
                    ` : ''}
                </div>
            `).join('');
            
            updateStats();
        }
        
        function updateStats() {
            let block=0, pic=0, picSupv=0, night=0, inst=0, toDay=0, toNight=0, ldDay=0, ldNight=0;
            flights.forEach(f => {
                block += f.blockTime || 0;
                pic += f.pic || 0;
                picSupv += f.picSupv || 0;
                night += f.night || 0;
                inst += f.instTime || 0;
                toDay += f.toDay || 0;
                toNight += f.toNight || 0;
                ldDay += f.ldDay || 0;
                ldNight += f.ldNight || 0;
            });
            
            document.getElementById('totalBlock').textContent = toDisplay(block + (prev.block||0));
            document.getElementById('totalPIC').textContent = toDisplay(pic + picSupv + (prev.pic||0) + (prev.picSupv||0));
            document.getElementById('totalNight').textContent = toDisplay(night + (prev.night||0));
            document.getElementById('totalInst').textContent = toDisplay(inst + (prev.inst||0));
            document.getElementById('totalTO').textContent = toDay + toNight + (prev.to||0);
            document.getElementById('totalLD').textContent = ldDay + ldNight + (prev.ld||0);
            
            document.getElementById('prevBlock').textContent = `ì´ì „: ${toDisplay(prev.block||0)}`;
            document.getElementById('prevPIC').textContent = `ì´ì „: ${toDisplay((prev.pic||0) + (prev.picSupv||0))}`;
            document.getElementById('prevNight').textContent = `ì´ì „: ${toDisplay(prev.night||0)}`;
            document.getElementById('prevInst').textContent = `ì´ì „: ${toDisplay(prev.inst||0)}`;
            document.getElementById('prevTO').textContent = `ì´ì „: ${prev.to||0}`;
            document.getElementById('prevLD').textContent = `ì´ì „: ${prev.ld||0}`;
        }
        
        // âœ… ì—°ë£Œ ê³„ì‚°
        window.calcFuel = function() {
            const out = parseFloat(document.getElementById('fuelRampOut').value) || 0;
            const in_ = parseFloat(document.getElementById('fuelRampIn').value) || 0;
            const trsv = parseFloat(document.getElementById('fuelTRSV').value) || 0;
            
            const used = out - in_;
            document.getElementById('calcFuelUsed').textContent = used > 0 ? used.toFixed(0) : '--';
            
            const reserve = in_ - trsv;
            const reserveText = reserve >= 0 ? `+${reserve.toFixed(0)}` : reserve.toFixed(0);
            document.getElementById('calcFuelReserve').textContent = (in_ > 0 && trsv > 0) ? `${reserveText} kg` : '--';
        };
        
        // âœ… ì‹œê°„ ìë™ ê³„ì‚°
        window.updateCalc = async function() {
            const rampOut = timeStr(document.getElementById('rampOutH').value, document.getElementById('rampOutM').value);
            const takeoff = timeStr(document.getElementById('takeoffH').value, document.getElementById('takeoffM').value);
            const landing = timeStr(document.getElementById('landingH').value, document.getElementById('landingM').value);
            const rampIn = timeStr(document.getElementById('rampInH').value, document.getElementById('rampInM').value);
            const times = calcTimes(rampOut, takeoff, landing, rampIn);
            
            document.getElementById('calcBlock').textContent = times.block > 0 ? toDisplay(times.block) : '--';
            document.getElementById('calcInst').textContent = times.inst > 0 ? toDisplay(times.inst) : '--';
            
            // INST ìë™ ì…ë ¥
            if (times.inst > 0) {
                const h = Math.floor(times.inst);
                const m = Math.round((times.inst - h) * 60);
                document.getElementById('instH').value = h;
                document.getElementById('instM').value = m;
            }
            
            // âœ… Day/Night ìë™ êµ¬ë¶„
            await autoDayNight();
        };
        
        // âœ… Day/Night ìë™ êµ¬ë¶„ (í•­ê³µ ê·œì • ì ìš©)
        async function autoDayNight() {
            const from = document.getElementById('from').value.trim().toUpperCase();
            const to = document.getElementById('to').value.trim().toUpperCase();
            const date = document.getElementById('date').value;
            const takeoffH = parseInt(document.getElementById('takeoffH').value) || 0;
            const takeoffM = parseInt(document.getElementById('takeoffM').value) || 0;
            const landingH = parseInt(document.getElementById('landingH').value) || 0;
            const landingM = parseInt(document.getElementById('landingM').value) || 0;
            
            const picH = parseInt(document.getElementById('picH').value) || 0;
            const picM = parseInt(document.getElementById('picM').value) || 0;
            const picSupvH = parseInt(document.getElementById('picSupvH').value) || 0;
            const picSupvM = parseInt(document.getElementById('picSupvM').value) || 0;
            
            const hasPIC = (picH > 0 || picM > 0) || (picSupvH > 0 || picSupvM > 0);
            if (!hasPIC || !from || !to || !date) return;
            
            // ì¼ì¶œì¼ëª° ì •ë³´ ê°€ì ¸ì˜¤ê¸° (DB ì‚¬ìš©)
            const depSun = getSunriseSunset(from, date);
            const arrSun = getSunriseSunset(to, date);
            
            // í•­ê³µ ê·œì • Night Period ê³„ì‚°
            const depNightStart = addMinutes(depSun.sunset, 60);
            const depNightEnd = subtractMinutes(depSun.sunrise, 60);
            const arrNightStart = addMinutes(arrSun.sunset, 60);
            const arrNightEnd = subtractMinutes(arrSun.sunrise, 60);
            
            // ì •ë³´ í‘œì‹œ
            document.getElementById('sunriseInfo').style.display = 'block';
            document.getElementById('sunriseText').innerHTML = `
                <strong>${from}:</strong> SR ${depSun.sunrise}, SS ${depSun.sunset} â†’ Night: ${depNightStart}~${depNightEnd}<br>
                <strong>${to}:</strong> SR ${arrSun.sunrise}, SS ${arrSun.sunset} â†’ Night: ${arrNightStart}~${arrNightEnd}
            `;
            
            // TAKEOFF Day/Night íŒë‹¨
            if (takeoffH > 0 && !document.getElementById('toDay').value && !document.getElementById('toNight').value) {
                const takeoffTime = `${pad(takeoffH)}:${pad(takeoffM)}`;
                const isNight = isNightTime(from, date, takeoffTime);
                document.getElementById('toDay').value = isNight ? 0 : 1;
                document.getElementById('toNight').value = isNight ? 1 : 0;
            }
            
            // LANDING Day/Night íŒë‹¨
            if (landingH > 0 && !document.getElementById('ldDay').value && !document.getElementById('ldNight').value) {
                const landingTime = `${pad(landingH)}:${pad(landingM)}`;
                const isNight = isNightTime(to, date, landingTime);
                document.getElementById('ldDay').value = isNight ? 0 : 1;
                document.getElementById('ldNight').value = isNight ? 1 : 0;
            }
        }
        
        // âœ… ì—­í•  ìë™ í• ë‹¹
        window.autoFillRole = async function(role) {
            const rampOut = timeStr(document.getElementById('rampOutH').value, document.getElementById('rampOutM').value);
            const rampIn = timeStr(document.getElementById('rampInH').value, document.getElementById('rampInM').value);
            const times = calcTimes(rampOut, '', '', rampIn);
            
            if (times.block === 0) {
                alert('ë¨¼ì € RAMP OUT/IN ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const h = Math.floor(times.block);
            const m = Math.round((times.block - h) * 60);
            
            ['pic', 'picSupv', 'coPilot', 'tr'].forEach(r => {
                document.getElementById(r + 'H').value = '';
                document.getElementById(r + 'M').value = '';
            });
            
            document.getElementById(role + 'H').value = h;
            document.getElementById(role + 'M').value = m;
            
            // PIC/PIC Supvì¸ ê²½ìš° Day/Night ìë™ êµ¬ë¶„
            if (role === 'pic' || role === 'picSupv') {
                await autoDayNight();
            }
        };
        
        // âœ… ë…¸ì„  ë§¤í•‘
        function loadRouteMapping() {
            const saved = localStorage.getItem('routeMapping');
            if (saved) routeMap = JSON.parse(saved);
        }
        
        window.applyRouteMapping = function() {
            const flt = document.getElementById('fltNo').value.trim().toUpperCase();
            if (flt && routeMap[flt]) {
                const [dep, arr] = routeMap[flt];
                document.getElementById('from').value = dep;
                document.getElementById('to').value = arr;
            }
        };
        
        window.showRouteModal = function() {
            const html = Object.keys(routeMap).map(flt => {
                const [dep, arr] = routeMap[flt];
                return `<div style="margin-bottom:10px;">${flt}: ${dep} â†’ ${arr} <button onclick="deleteRoute('${flt}')" style="margin-left:10px;">ğŸ—‘ï¸</button></div>`;
            }).join('');
            document.getElementById('routeList').innerHTML = html || '<p>ë“±ë¡ëœ ë…¸ì„ ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            document.getElementById('routeModal').classList.add('show');
        };
        
        window.closeRouteModal = function() {
            document.getElementById('routeModal').classList.remove('show');
        };
        
        window.addRoute = function() {
            const flt = prompt('ë¹„í–‰í¸ëª…:');
            if (!flt) return;
            const dep = prompt('ì¶œë°œ:');
            if (!dep) return;
            const arr = prompt('ë„ì°©:');
            if (!arr) return;
            routeMap[flt.toUpperCase()] = [dep.toUpperCase(), arr.toUpperCase()];
            localStorage.setItem('routeMapping', JSON.stringify(routeMap));
            showRouteModal();
        };
        
        window.deleteRoute = function(flt) {
            delete routeMap[flt];
            localStorage.setItem('routeMapping', JSON.stringify(routeMap));
            showRouteModal();
        };
        
        // âœ… ëª¨ë‹¬
        window.showAddModal = function() {
            document.getElementById('modalTitle').textContent = 'âœˆï¸ ìƒˆ ë¹„í–‰ ê¸°ë¡';
            document.getElementById('editId').value = '';
            document.getElementById('modal').classList.add('show');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            ['rampOutH', 'rampOutM', 'takeoffH', 'takeoffM', 'landingH', 'landingM', 'rampInH', 'rampInM'].forEach(id => {
                const el = document.getElementById(id);
                el.removeEventListener('input', updateCalc);
                el.addEventListener('input', updateCalc);
            });
        };
        
        window.closeModal = function() {
            document.getElementById('modal').classList.remove('show');
            document.querySelector('form').reset();
        };
        
        window.saveFlight = async function(e) {
            e.preventDefault();
            
            const rampOut = timeStr(document.getElementById('rampOutH').value, document.getElementById('rampOutM').value);
            const takeoff = timeStr(document.getElementById('takeoffH').value, document.getElementById('takeoffM').value);
            const landing = timeStr(document.getElementById('landingH').value, document.getElementById('landingM').value);
            const rampIn = timeStr(document.getElementById('rampInH').value, document.getElementById('rampInM').value);
            const times = calcTimes(rampOut, takeoff, landing, rampIn);
            
            const fuelOut = parseFloat(document.getElementById('fuelRampOut').value) || 0;
            const fuelIn = parseFloat(document.getElementById('fuelRampIn').value) || 0;
            const fuelTRSV = parseFloat(document.getElementById('fuelTRSV').value) || 0;
            
            const data = {
                id: document.getElementById('editId').value || `flight_${Date.now()}`,
                date: document.getElementById('date').value,
                aircraft: document.getElementById('aircraft').value,
                acIdent: document.getElementById('acIdent').value,
                fltNo: document.getElementById('fltNo').value,
                from: document.getElementById('from').value.toUpperCase(),
                to: document.getElementById('to').value.toUpperCase(),
                rampOut, takeoff, landing, rampIn,
                blockTime: times.block,
                instTime: toDec(+document.getElementById('instH').value, +document.getElementById('instM').value),
                pic: toDec(+document.getElementById('picH').value, +document.getElementById('picM').value),
                picSupv: toDec(+document.getElementById('picSupvH').value, +document.getElementById('picSupvM').value),
                coPilot: toDec(+document.getElementById('coPilotH').value, +document.getElementById('coPilotM').value),
                tr: toDec(+document.getElementById('trH').value, +document.getElementById('trM').value),
                night: toDec(+document.getElementById('nightH').value, +document.getElementById('nightM').value),
                appType: document.getElementById('appType').value,
                toDay: +document.getElementById('toDay').value || 0,
                toNight: +document.getElementById('toNight').value || 0,
                ldDay: +document.getElementById('ldDay').value || 0,
                ldNight: +document.getElementById('ldNight').value || 0,
                fuelRampOut: fuelOut,
                fuelRampIn: fuelIn,
                fuelTRSV: fuelTRSV,
                fuelUsed: fuelOut > 0 && fuelIn > 0 ? fuelOut - fuelIn : 0,
                fuelReserve: fuelIn > 0 && fuelTRSV > 0 ? fuelIn - fuelTRSV : 0,
                remark: document.getElementById('remark').value,
                landingScore: parseInt(document.getElementById('landingScore').value) || 0,
                wxDest: document.getElementById('wxDest').value,
                landingComment: document.getElementById('landingComment').value,
                clearance: document.getElementById('clearance').value,
                tip: document.getElementById('tip').value
            };
            
            await saveFlightToFirebase(data);
            closeModal();
        };
        
        window.editFlight = function(id) {
            const f = flights.find(x => x.id === id);
            if (!f) return;
            
            document.getElementById('modalTitle').textContent = 'âœï¸ ë¹„í–‰ ê¸°ë¡ ìˆ˜ì •';
            document.getElementById('editId').value = id;
            document.getElementById('date').value = f.date;
            document.getElementById('aircraft').value = f.aircraft;
            document.getElementById('acIdent').value = f.acIdent || '';
            document.getElementById('fltNo').value = f.fltNo || '';
            document.getElementById('from').value = f.from;
            document.getElementById('to').value = f.to;
            
            // âœ… UTC ì‹œê°„ ì•ˆì „í•˜ê²Œ íŒŒì‹±
            const parseTimeString = (timeStr) => {
                if (!timeStr) return { h: '', m: '' };
                
                // "11:38" í˜•ì‹
                if (timeStr.includes(':')) {
                    const [h, m] = timeStr.split(':');
                    return { h: parseInt(h) || '', m: parseInt(m) || '' };
                }
                
                // ì˜ëª»ëœ decimal í˜•ì‹ (0.79861) - ë³€í™˜
                const num = parseFloat(timeStr);
                if (!isNaN(num) && num < 1) {
                    const totalMinutes = Math.round(num * 1440);
                    const h = Math.floor(totalMinutes / 60) % 24;
                    const m = totalMinutes % 60;
                    return { h, m };
                }
                
                return { h: '', m: '' };
            };
            
            const rampOutTime = parseTimeString(f.rampOut);
            document.getElementById('rampOutH').value = rampOutTime.h;
            document.getElementById('rampOutM').value = rampOutTime.m;
            
            const takeoffTime = parseTimeString(f.takeoff);
            document.getElementById('takeoffH').value = takeoffTime.h;
            document.getElementById('takeoffM').value = takeoffTime.m;
            
            const landingTime = parseTimeString(f.landing);
            document.getElementById('landingH').value = landingTime.h;
            document.getElementById('landingM').value = landingTime.m;
            
            const rampInTime = parseTimeString(f.rampIn);
            document.getElementById('rampInH').value = rampInTime.h;
            document.getElementById('rampInM').value = rampInTime.m;
            
            const fillTime = (prefix, val) => {
                if (!val) return;
                const h = Math.floor(val);
                const m = Math.round((val - h) * 60);
                document.getElementById(prefix + 'H').value = h;
                document.getElementById(prefix + 'M').value = m;
            };
            
            fillTime('pic', f.pic);
            fillTime('picSupv', f.picSupv);
            fillTime('coPilot', f.coPilot);
            fillTime('tr', f.tr);
            fillTime('night', f.night);
            fillTime('inst', f.instTime);
            
            document.getElementById('appType').value = f.appType || '';
            document.getElementById('toDay').value = f.toDay || '';
            document.getElementById('toNight').value = f.toNight || '';
            document.getElementById('ldDay').value = f.ldDay || '';
            document.getElementById('ldNight').value = f.ldNight || '';
            document.getElementById('fuelRampOut').value = f.fuelRampOut || '';
            document.getElementById('fuelRampIn').value = f.fuelRampIn || '';
            document.getElementById('fuelTRSV').value = f.fuelTRSV || '';
            document.getElementById('remark').value = f.remark || '';
            document.getElementById('landingScore').value = f.landingScore || '';
            document.getElementById('wxDest').value = f.wxDest || '';
            document.getElementById('landingComment').value = f.landingComment || '';
            document.getElementById('clearance').value = f.clearance || '';
            document.getElementById('tip').value = f.tip || '';
            
            window.updateCalc();
            calcFuel();
            document.getElementById('modal').classList.add('show');
        };
        
        window.deleteFlight = async function(id) {
            if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            setSyncStatus('connecting', 'ğŸ”„ ì‚­ì œ ì¤‘...');
            const flightRef = doc(db, 'users', userId, 'flights', id);
            await deleteDoc(flightRef);
            setSyncStatus('connected', 'â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°ë¨');
        };
        
        window.saveFirebaseConfig = function() {
            const config = {
                apiKey: document.getElementById('apiKey').value.trim(),
                projectId: document.getElementById('projectId').value.trim(),
                appId: document.getElementById('appId').value.trim()
            };
            if (!config.apiKey || !config.projectId || !config.appId) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            initFirebase(config);
        };
        
        window.showFirebaseSettings = function() {
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('apiKey').value = config.apiKey;
                document.getElementById('projectId').value = config.projectId;
                document.getElementById('appId').value = config.appId;
            }
            document.getElementById('setupPanel').style.display = 'block';
            document.getElementById('app').style.display = 'none';
        };
        
        window.clearFirebaseConfig = function() {
            if (confirm('Firebase ì„¤ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('firebaseConfig');
                alert('ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
            }
        };
        
        window.resetAll = async function() {
            if (!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const flightsRef = collection(db, 'users', userId, 'flights');
            const snapshot = await getDocs(flightsRef);
            const promises = [];
            snapshot.forEach(d => promises.push(deleteDoc(d.ref)));
            await Promise.all(promises);
            flights = [];
            prev = {};
            render(flights);
            alert('ë¦¬ì…‹ ì™„ë£Œ!');
        };
        
        window.importExcel = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array', cellDates: false });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    
                    const parseTimedelta = (cell) => {
                        if (!cell || cell.v === undefined) return 0;
                        if (typeof cell.v === 'number') return cell.v * 24;
                        return 0;
                    };
                    
                    const parseExcelDate = (serial) => {
                        const epoch = new Date(1899, 11, 30);
                        const jsDate = new Date(epoch.getTime() + serial * 86400000);
                        return jsDate;
                    };
                    
                    // âœ… Excel ì‹œê°„ íŒŒì‹± (SheetJS í˜•ì‹ â†’ "HH:MM")
                    const parseExcelTime = (cell) => {
                        if (!cell || cell.v === undefined || cell.v === null) return '';
                        const val = cell.v;
                        
                        // ë¬¸ìì—´ì¸ ê²½ìš° (ì´ë¯¸ "11:38" í˜•ì‹)
                        if (typeof val === 'string') {
                            // "11:38:00" â†’ "11:38"
                            return val.split(':').slice(0, 2).join(':');
                        }
                        
                        // SheetJS decimal í˜•ì‹ (0.48472 = 11:38)
                        if (typeof val === 'number') {
                            const totalMinutes = Math.round(val * 1440);
                            const hours = Math.floor(totalMinutes / 60) % 24;
                            const minutes = totalMinutes % 60;
                            return `${pad(hours)}:${pad(minutes)}`;
                        }
                        
                        return '';
                    };
                    
                    prev = {
                        block: parseTimedelta(ws['K6']),
                        pic: parseTimedelta(ws['G6']),
                        picSupv: parseTimedelta(ws['H6']),
                        coPilot: parseTimedelta(ws['I6']),
                        tr: parseTimedelta(ws['J6']),
                        night: parseTimedelta(ws['L6']),
                        inst: parseTimedelta(ws['M6']),
                        to: (parseInt(ws['O6']?.v || 0)) + (parseInt(ws['P6']?.v || 0)),
                        ld: (parseInt(ws['Q6']?.v || 0)) + (parseInt(ws['R6']?.v || 0))
                    };
                    
                    await savePreviousToFirebase();
                    
                    let imported = 0;
                    for (let row = 7; row <= 200; row++) {
                        const cellA = ws[`A${row}`];
                        if (!cellA) break;
                        
                        const dateVal = cellA.v;
                        if (!dateVal) break;
                        
                        let dateStr = '';
                        if (typeof dateVal === 'number') {
                            const jsDate = parseExcelDate(dateVal);
                            dateStr = `${jsDate.getFullYear()}-${String(jsDate.getMonth()+1).padStart(2,'0')}-${String(jsDate.getDate()).padStart(2,'0')}`;
                        }
                        
                        if (dateStr.includes('2023-2025')) break;
                        
                        const flightData = {
                            id: `flight_${Date.now()}_${row}`,
                            date: dateStr,
                            aircraft: (ws[`B${row}`]?.v || '').toString(),
                            acIdent: (ws[`C${row}`]?.v || '').toString(),
                            fltNo: (ws[`D${row}`]?.v || '').toString(),
                            from: (ws[`E${row}`]?.v || '').toString(),
                            to: (ws[`F${row}`]?.v || '').toString(),
                            
                            // âœ… UTC ì‹œê°„ (AG~AJ) - parseExcelTime ì‚¬ìš©
                            rampOut: parseExcelTime(ws[`AG${row}`]),
                            takeoff: parseExcelTime(ws[`AH${row}`]),
                            landing: parseExcelTime(ws[`AI${row}`]),
                            rampIn: parseExcelTime(ws[`AJ${row}`]),
                            
                            // ì—­í• ë³„ ì‹œê°„
                            blockTime: parseTimedelta(ws[`K${row}`]),
                            pic: parseTimedelta(ws[`G${row}`]),
                            picSupv: parseTimedelta(ws[`H${row}`]),
                            coPilot: parseTimedelta(ws[`I${row}`]),
                            tr: parseTimedelta(ws[`J${row}`]),
                            night: parseTimedelta(ws[`L${row}`]),
                            instTime: parseTimedelta(ws[`M${row}`]),
                            
                            // ì ‘ê·¼ & ì´ì°©ë¥™
                            appType: (ws[`N${row}`]?.v || '').toString(),
                            toDay: parseInt(ws[`O${row}`]?.v || 0),
                            toNight: parseInt(ws[`P${row}`]?.v || 0),
                            ldDay: parseInt(ws[`Q${row}`]?.v || 0),
                            ldNight: parseInt(ws[`R${row}`]?.v || 0),
                            
                            // ê¸°íƒ€
                            remark: (ws[`S${row}`]?.v || '').toString(),
                            
                            // ì—°ë£Œ (AK~AL)
                            fuelRampOut: parseFloat(ws[`AK${row}`]?.v || 0),
                            fuelRampIn: parseFloat(ws[`AL${row}`]?.v || 0),
                            fuelTRSV: 0,
                            fuelUsed: 0,
                            fuelReserve: 0,
                            
                            // ì¶”ê°€ ìƒì„¸ (AM~AQ)
                            landingScore: parseInt(ws[`AM${row}`]?.v || 0),
                            wxDest: (ws[`AN${row}`]?.v || '').toString(),
                            landingComment: (ws[`AO${row}`]?.v || '').toString(),
                            clearance: (ws[`AP${row}`]?.v || '').toString(),
                            tip: (ws[`AQ${row}`]?.v || '').toString()
                        };
                        
                        await saveFlightToFirebase(flightData);
                        imported++;
                    }
                    
                    alert(`âœ… ${imported}ê°œ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!`);
                } catch (err) {
                    console.error('Excel ì˜¤ë¥˜:', err);
                    alert('Excel ì˜¤ë¥˜: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        window.exportExcel = function() {
            const wb = XLSX.utils.book_new();
            const data = [[
                'Date', 'A/C Type', 'A/C Ident', 'FLT NO', 'From', 'To',
                'PIC', 'PIC Supv', 'CoPilot', 'TR', 'BLOCK', 'NIGHT', 'INST',
                'APP TYPE', 'TO Day', 'TO Night', 'LD Day', 'LD Night', 'Remark',
                'Rmp Out', 'TakeOff', 'Landing', 'Rmp In',
                'Fuel Out', 'Fuel In', 'Score', 'Wx Dest', 'Land Comment', 'Clearance', 'TIP'
            ]];
            flights.forEach(f => {
                data.push([
                    f.date, f.aircraft, f.acIdent, f.fltNo, f.from, f.to,
                    toDisplay(f.pic), toDisplay(f.picSupv), toDisplay(f.coPilot), toDisplay(f.tr),
                    toDisplay(f.blockTime), toDisplay(f.night), toDisplay(f.instTime),
                    f.appType || '', f.toDay, f.toNight, f.ldDay, f.ldNight, f.remark,
                    f.rampOut, f.takeoff, f.landing, f.rampIn,
                    f.fuelRampOut, f.fuelRampIn, f.landingScore, f.wxDest, f.landingComment, f.clearance, f.tip
                ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Log');
            XLSX.writeFile(wb, `LOG_${new Date().toISOString().split('T')[0]}.xlsx`);
        };
        
        // ì´ˆê¸°í™”
        loadRouteMapping();
        const savedConfig = localStorage.getItem('firebaseConfig');
        if (savedConfig) {
            const config = JSON.parse(savedConfig);
            document.getElementById('apiKey').value = config.apiKey;
            document.getElementById('projectId').value = config.projectId;
            document.getElementById('appId').value = config.appId;
            initFirebase(config);
        }
    </script>
</body>
</html>
