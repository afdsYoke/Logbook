<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ë¹„í–‰ì‹œê°„ ê¸°ë¡ë¶€ - Cloud Sync</title>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1e293b 100%);
            color: #e2e8f0;
            padding: 15px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Firebase Setup Panel */
        .setup-panel {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.4);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
        }
        .setup-panel h2 { color: #60a5fa; margin-bottom: 15px; }
        .setup-panel p { margin-bottom: 15px; line-height: 1.6; }
        .setup-form { display: grid; gap: 12px; margin-top: 20px; }
        .setup-input {
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            font-family: monospace;
        }
        
        .sync-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
        }
        .sync-status.connecting {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }
        .sync-status.connected {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }
        .sync-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }
        
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(37, 99, 235, 0.4);
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        
        #app { display: none; }
        #app.ready { display: block; }
        
        .main-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .main-stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
            border-radius: 14px;
            padding: 20px;
            border-left: 5px solid;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .main-stat-card h3 { 
            font-size: 12px; 
            color: #94a3b8; 
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .main-stat-card .value { 
            font-size: 32px; 
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }
        .main-stat-card .subtext {
            font-size: 11px;
            color: #64748b;
            margin-top: 5px;
        }
        
        .buttons { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        button, .btn-label {
            padding: 11px 18px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-secondary { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 2px solid rgba(59, 130, 246, 0.4); }
        .btn-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 2px solid rgba(245, 158, 11, 0.4); }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 2px solid rgba(239, 68, 68, 0.4); }
        
        .filter-bar {
            background: rgba(30, 41, 59, 0.6);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(51, 65, 85, 0.6);
        }
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-label { font-size: 11px; color: #94a3b8; margin-bottom: 5px; }
        .filter-input, .filter-select {
            padding: 8px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 13px;
        }
        .filter-btn-group { display: flex; gap: 8px; align-items: flex-end; }
        .filter-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }
        
        .card {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(51, 65, 85, 0.6);
        }
        
        .flight-row {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 15px;
            padding-right: 110px;
            margin-bottom: 12px;
            border: 1px solid rgba(51, 65, 85, 0.4);
            transition: all 0.3s;
            position: relative;
        }
        .flight-row:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(59, 130, 246, 0.4);
        }
        .flight-info { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); 
            gap: 10px; 
        }
        .flight-info-label { font-size: 9px; color: #64748b; margin-bottom: 2px; }
        .flight-info-value { font-size: 12px; font-weight: 600; }
        
        .flight-details {
            background: rgba(59, 130, 246, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid #3b82f6;
        }
        .detail-item {
            font-size: 11px;
            color: #cbd5e1;
            margin-bottom: 5px;
        }
        .detail-item strong { color: #94a3b8; }
        
        .action-btns {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .action-btn {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            color: #60a5fa;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
        }
        .action-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #f87171;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 1000;
            padding: 15px;
            overflow-y: auto;
        }
        .modal.show { display: flex; align-items: flex-start; justify-content: center; padding-top: 20px; }
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 25px;
            max-width: 900px;
            width: 100%;
            border: 1px solid rgba(51, 65, 85, 0.6);
            margin-bottom: 40px;
        }
        
        .form-group { margin-bottom: 12px; }
        .form-group label { 
            display: block; 
            margin-bottom: 6px; 
            font-size: 12px; 
            font-weight: 600; 
            color: #94a3b8; 
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 11px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
        }
        .form-group textarea { min-height: 60px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .form-row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; }
        .form-section { 
            background: rgba(59, 130, 246, 0.08); 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
        }
        .form-section h3 { font-size: 15px; color: #60a5fa; margin-bottom: 12px; }
        
        .time-input-group { display: flex; gap: 6px; align-items: center; }
        .time-input { flex: 1; text-align: center; }
        .time-separator { font-size: 18px; font-weight: 700; color: #94a3b8; }
        
        input[type="file"] { display: none; }
        .empty-state { text-align: center; padding: 50px 20px; color: #64748b; }
        
        @media (max-width: 768px) {
            .form-row, .form-row-3, .form-row-4 { grid-template-columns: 1fr; }
            .main-stats { grid-template-columns: repeat(2, 1fr); }
            .filter-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Firebase Setup -->
        <div id="setupPanel" class="setup-panel">
            <h2>ğŸ”¥ Firebase í´ë¼ìš°ë“œ ë™ê¸°í™” ì„¤ì •</h2>
            <p>
                PCì™€ í°ì—ì„œ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ë ¤ë©´ Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
                <strong>ë¬´ë£Œ</strong>ì´ë©°, ì„¤ì •ì€ í•œ ë²ˆë§Œ í•˜ë©´ ë©ë‹ˆë‹¤!
            </p>
            <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 3px solid #10b981;">
                <div style="color: #34d399; font-weight: 600; margin-bottom: 5px;">âœ… ìë™ ë™ê¸°í™” ì„¤ì •ë¨</div>
                <div style="font-size: 13px; color: #cbd5e1;">
                    PCì™€ ì•„ì´í°ì—ì„œ <strong>ê°™ì€ Firebase ì„¤ì •</strong>ì„ ì…ë ¥í•˜ë©´<br>
                    ëª¨ë“  ê¸°ê¸°ì—ì„œ ìë™ìœ¼ë¡œ ë°ì´í„°ê°€ ë™ê¸°í™”ë©ë‹ˆë‹¤!
                </div>
            </div>
            
            <div class="setup-form">
                <input type="text" class="setup-input" id="apiKey" placeholder="API Key (ì˜ˆ: AIzaSyABC123...)" />
                <input type="text" class="setup-input" id="projectId" placeholder="Project ID (ì˜ˆ: my-logbook-12345)" />
                <input type="text" class="setup-input" id="appId" placeholder="App ID (ì˜ˆ: 1:1234567890:web:abc123)" />
                
                <button class="btn-primary" onclick="saveFirebaseConfig()" style="margin-top: 10px;">
                    âœ… ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°
                </button>
                
                <button class="btn-danger" onclick="clearFirebaseConfig()" style="margin-top: 5px;">
                    ğŸ—‘ï¸ ì €ì¥ëœ ì„¤ì • ì‚­ì œ
                </button>
            </div>
            
            <div id="setupStatus" style="margin-top: 15px; color: #f87171;"></div>
        </div>
        
        <div class="header">
            <h1>âœˆï¸ Pilot Flight Logbook</h1>
            <p>Professional Flight Time Recording System - Cloud Sync</p>
            <div class="sync-status connecting" id="syncStatus">
                ğŸ”„ Firebase ì„¤ì • ëŒ€ê¸° ì¤‘...
            </div>
            <div id="projectInfo" style="font-size: 12px; color: #94a3b8; margin-top: 8px; display: none;">
                ğŸ“¦ í”„ë¡œì íŠ¸: <span id="currentProject"></span>
            </div>
        </div>

        <div id="app">
            <div class="main-stats">
                <div class="main-stat-card" style="border-left-color: #3b82f6;">
                    <h3>Total Block Time</h3>
                    <div class="value" style="color: #3b82f6;" id="totalBlock">0:00</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #10b981;">
                    <h3>Total PIC</h3>
                    <div class="value" style="color: #10b981;" id="totalPIC">0:00</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #8b5cf6;">
                    <h3>Night Time</h3>
                    <div class="value" style="color: #8b5cf6;" id="totalNight">0:00</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #f59e0b;">
                    <h3>Instrument</h3>
                    <div class="value" style="color: #f59e0b;" id="totalInst">0:00</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #ec4899;">
                    <h3>Takeoffs</h3>
                    <div class="value" style="color: #ec4899;" id="totalTO">0</div>
                </div>
                <div class="main-stat-card" style="border-left-color: #06b6d4;">
                    <h3>Landings</h3>
                    <div class="value" style="color: #06b6d4;" id="totalLD">0</div>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-primary" onclick="showAddModal()">â• ë¹„í–‰ ì¶”ê°€</button>
                <button class="btn-secondary" onclick="document.getElementById('excelFile').click()">ğŸ“¤ ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°</button>
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="importExcel(event)" />
                <button class="btn-warning" onclick="exportExcel()">ğŸ“¥ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn-secondary" onclick="showFirebaseSettings()">âš™ï¸ Firebase ì„¤ì •</button>
                <button class="btn-danger" onclick="resetAll()">ğŸ”„ ì „ì²´ ë¦¬ì…‹</button>
            </div>

            <div class="filter-bar">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">ğŸ” ê²€ìƒ‰</label>
                        <input type="text" class="filter-input" id="searchText" placeholder="í¸ëª…, ê³µí•­, ë¹„ê³ ...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“… ë‚ ì§œ (ì‹œì‘)</label>
                        <input type="date" class="filter-input" id="dateFrom">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“… ë‚ ì§œ (ì¢…ë£Œ)</label>
                        <input type="date" class="filter-input" id="dateTo">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">âœˆï¸ í•­ê³µê¸°</label>
                        <select class="filter-select" id="aircraftFilter">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ›« ì¶œë°œì§€</label>
                        <select class="filter-select" id="fromFilter">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ›¬ ë„ì°©ì§€</label>
                        <select class="filter-select" id="toFilter">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                </div>
                <div class="filter-btn-group">
                    <button class="filter-btn" onclick="applyFilters()">âœ… í•„í„° ì ìš©</button>
                    <button class="filter-btn" onclick="clearFilters()">âŒ í•„í„° ì´ˆê¸°í™”</button>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 18px; font-size: 19px;">ë¹„í–‰ ê¸°ë¡ (<span id="count">0</span>)</h2>
                <div id="list">
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 12px;">âœˆï¸</div>
                        <p>ë¹„í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;" id="modalTitle">âœˆï¸ ìƒˆ ë¹„í–‰ ê¸°ë¡</h2>
            <form onsubmit="saveFlight(event)">
                <input type="hidden" id="editId">
                
                <div class="form-section">
                    <h3>ğŸ“… ê¸°ë³¸ ì •ë³´</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ë‚ ì§œ *</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>í•­ê³µê¸° *</label>
                            <input type="text" id="aircraft" placeholder="B737" required>
                        </div>
                    </div>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>FLT NO</label>
                            <input type="text" id="fltNo" placeholder="KE123">
                        </div>
                        <div class="form-group">
                            <label>ì¶œë°œ *</label>
                            <input type="text" id="from" placeholder="RKSI" required>
                        </div>
                        <div class="form-group">
                            <label>ë„ì°© *</label>
                            <input type="text" id="to" placeholder="RJAA" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ‘¨â€âœˆï¸ ë¹„í–‰ ì‹œê°„ (ì‹œ:ë¶„)</h3>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>BLOCK</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="blockH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="blockM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>NIGHT</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="nightH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="nightM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>INST</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="instH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="instM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                    </div>
                    <div class="form-row-4">
                        <div class="form-group">
                            <label>PIC</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="picH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="picM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>PIC_Supv</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="picSupvH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="picSupvM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>CoPilot</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="coPilotH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="coPilotM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>TR</label>
                            <div class="time-input-group">
                                <input type="number" class="time-input" id="trH" min="0" placeholder="ì‹œ">
                                <span class="time-separator">:</span>
                                <input type="number" class="time-input" id="trM" min="0" max="59" placeholder="ë¶„">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ›¬ ì´ì°©ë¥™</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Takeoffs (íšŸìˆ˜)</label>
                            <input type="number" id="toCount" placeholder="1" min="0">
                        </div>
                        <div class="form-group">
                            <label>Landings (íšŸìˆ˜)</label>
                            <input type="number" id="ldCount" placeholder="1" min="0">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>ğŸ“ ìƒì„¸ ì •ë³´</h3>
                    <div class="form-group">
                        <label>ë¹„ê³  (Remark)</label>
                        <input type="text" id="remark" placeholder="C ê¹€ì² ìˆ˜">
                    </div>
                    <div class="form-group">
                        <label>ê¸°ìƒ (Wx)</label>
                        <input type="text" id="wx" placeholder="CAVOK">
                    </div>
                    <div class="form-group">
                        <label>Landing Comment</label>
                        <textarea id="landingCmt"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Clearance</label>
                        <textarea id="clearance"></textarea>
                    </div>
                    <div class="form-group">
                        <label>TIP</label>
                        <textarea id="tip"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn-primary" style="flex: 1; padding: 14px;">ì €ì¥</button>
                    <button type="button" class="btn-secondary" style="flex: 1; padding: 14px;" onclick="closeModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK (CDN) -->
    <script type="module">
        import { initializeApp, getApps, deleteApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        
        console.log('ğŸ”¥ Firebase SDK ë¡œë“œ ì™„ë£Œ');
        console.log('ğŸ“Š SheetJS ì‚¬ìš© ê°€ëŠ¥:', typeof XLSX !== 'undefined');
        
        // ì „ì—­ ë³€ìˆ˜
        let db = null;
        let auth = null;
        let userId = null;
        let flights = [];
        let unsubscribe = null;
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function pad(n) { return String(n).padStart(2, '0'); }
        function toDisplay(dec) {
            if (!dec) return '0:00';
            const h = Math.floor(dec);
            const m = Math.round((dec - h) * 60);
            return `${h}:${pad(m)}`;
        }
        function toDec(h, m) { return (h || 0) + (m || 0) / 60; }
        
        // ì‹œê°„ ë¬¸ìì—´ íŒŒì‹± ("4:34" â†’ 4.567)
        function parseTimeString(timeStr) {
            if (!timeStr) return 0;
            const str = timeStr.toString().trim();
            const match = str.match(/(\d+):(\d+)/);
            if (match) {
                const h = parseInt(match[1]);
                const m = parseInt(match[2]);
                return h + m / 60;
            }
            return 0;
        }
        
        function setSyncStatus(status, text) {
            const el = document.getElementById('syncStatus');
            el.className = `sync-status ${status}`;
            el.textContent = text;
        }
        
        // Firebase ì´ˆê¸°í™”
        async function initFirebase(config) {
            try {
                console.log('Firebase ì´ˆê¸°í™” ì‹œì‘...');
                setSyncStatus('connecting', 'ğŸ”„ ì—°ê²° ì¤‘...');
                
                // ê¸°ì¡´ ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘ì§€
                if (unsubscribe) {
                    console.log('ê¸°ì¡´ ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘ì§€ ì¤‘...');
                    unsubscribe();
                    unsubscribe = null;
                }
                
                // ê¸°ì¡´ Firebase ì•± ì •ë¦¬
                const existingApps = getApps();
                if (existingApps.length > 0) {
                    console.log('ê¸°ì¡´ Firebase ì•± ì‚­ì œ ì¤‘...');
                    for (const existingApp of existingApps) {
                        await deleteApp(existingApp);
                    }
                    console.log('âœ… ê¸°ì¡´ ì•± ì‚­ì œ ì™„ë£Œ');
                }
                
                // ìƒˆ Firebase ì•± ì´ˆê¸°í™”
                const app = initializeApp({
                    apiKey: config.apiKey,
                    authDomain: `${config.projectId}.firebaseapp.com`,
                    projectId: config.projectId,
                    storageBucket: `${config.projectId}.appspot.com`,
                    appId: config.appId
                });
                
                db = getFirestore(app);
                auth = getAuth(app);
                
                // âœ… ê³ ì • User ID ì‚¬ìš© (ëª¨ë“  ê¸°ê¸°ì—ì„œ ë™ì¼)
                // ì´ë ‡ê²Œ í•˜ë©´ PC, ì•„ì´í°, ëª¨ë“  ê¸°ê¸°ì—ì„œ ê°™ì€ ë°ì´í„° ê³µìœ !
                userId = 'pilot-logbook-user';
                
                // ìµëª… ì¸ì¦ì€ Firebase ê·œì¹™ í†µê³¼ìš©
                await signInAnonymously(auth);
                
                console.log('âœ… ì¸ì¦ ì™„ë£Œ. User ID:', userId);
                console.log('ğŸ’¡ ëª¨ë“  ê¸°ê¸°ì—ì„œ ê°™ì€ User IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                
                await loadData();
                setupRealtimeSync();
                
                document.getElementById('setupPanel').style.display = 'none';
                document.getElementById('app').classList.add('ready');
                setSyncStatus('connected', 'â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°ë¨');
                
                // í”„ë¡œì íŠ¸ ì •ë³´ í‘œì‹œ
                document.getElementById('projectInfo').style.display = 'block';
                document.getElementById('currentProject').textContent = config.projectId;
                
                console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ!');
                
            } catch (error) {
                console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                setSyncStatus('error', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                document.getElementById('setupStatus').textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }
        
        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                console.log('ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                
                const flightsRef = collection(db, 'users', userId, 'flights');
                const snapshot = await getDocs(flightsRef);
                
                flights = [];
                snapshot.forEach(doc => {
                    flights.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`âœ… ${flights.length}ê°œ ë¹„í–‰ ê¸°ë¡ ë¡œë“œë¨`);
                
                applyFilters();
                updateFilterOptions();
                
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // ì‹¤ì‹œê°„ ë™ê¸°í™”
        function setupRealtimeSync() {
            const flightsRef = collection(db, 'users', userId, 'flights');
            
            unsubscribe = onSnapshot(flightsRef, (snapshot) => {
                console.log('ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°ì§€');
                
                flights = [];
                snapshot.forEach(doc => {
                    flights.push({ id: doc.id, ...doc.data() });
                });
                
                applyFilters();
                updateFilterOptions();
            });
            
            console.log('âœ… ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”');
        }
        
        // ë¹„í–‰ ì €ì¥
        async function saveFlightToFirebase(flightData) {
            try {
                setSyncStatus('connecting', 'ğŸ”„ ì €ì¥ ì¤‘...');
                
                const flightId = flightData.id || `flight_${Date.now()}`;
                const flightRef = doc(db, 'users', userId, 'flights', flightId);
                
                await setDoc(flightRef, flightData);
                
                console.log('âœ… ë¹„í–‰ ì €ì¥ ì™„ë£Œ:', flightId);
                setSyncStatus('connected', 'â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°ë¨');
                
                return flightId;
                
            } catch (error) {
                console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
                setSyncStatus('error', 'âŒ ì €ì¥ ì‹¤íŒ¨');
                throw error;
            }
        }
        
        // ë¹„í–‰ ì‚­ì œ
        async function deleteFlightFromFirebase(flightId) {
            try {
                setSyncStatus('connecting', 'ğŸ”„ ì‚­ì œ ì¤‘...');
                
                const flightRef = doc(db, 'users', userId, 'flights', flightId);
                await deleteDoc(flightRef);
                
                console.log('âœ… ë¹„í–‰ ì‚­ì œ ì™„ë£Œ:', flightId);
                setSyncStatus('connected', 'â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°ë¨');
                
            } catch (error) {
                console.error('âŒ ì‚­ì œ ì‹¤íŒ¨:', error);
                throw error;
            }
        }
        
        // ë Œë”ë§
        function render(list) {
            document.getElementById('count').textContent = list.length;
            
            if (list.length === 0) {
                document.getElementById('list').innerHTML = 
                    '<div class="empty-state"><div style="font-size:48px;">âœˆï¸</div><p>ë¹„í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                updateStats();
                return;
            }
            
            document.getElementById('list').innerHTML = list.slice().reverse().map(f => {
                const details = f.remark || f.wx || f.landingCmt || f.clearance || f.tip;
                return `
                    <div class="flight-row">
                        <div class="action-btns">
                            <button class="action-btn" onclick="window.showEditModal('${f.id}')">âœï¸ ìˆ˜ì •</button>
                            <button class="action-btn delete" onclick="window.deleteFlightHandler('${f.id}')">ğŸ—‘ï¸</button>
                        </div>
                        <div class="flight-info">
                            <div><div class="flight-info-label">ë‚ ì§œ</div><div class="flight-info-value">${f.date}</div></div>
                            <div><div class="flight-info-label">í•­ê³µê¸°</div><div class="flight-info-value">${f.aircraft}</div></div>
                            <div><div class="flight-info-label">FLT NO</div><div class="flight-info-value">${f.fltNo||'-'}</div></div>
                            <div><div class="flight-info-label">êµ¬ê°„</div><div class="flight-info-value">${f.from}â†’${f.to}</div></div>
                            <div><div class="flight-info-label">BLOCK</div><div class="flight-info-value" style="color:#60a5fa;">${toDisplay(f.blockTime)}</div></div>
                            <div><div class="flight-info-label">PIC</div><div class="flight-info-value" style="color:#34d399;">${toDisplay(f.pic)}</div></div>
                            <div><div class="flight-info-label">PIC_Supv</div><div class="flight-info-value" style="color:#34d399;">${toDisplay(f.picSupv)}</div></div>
                            <div><div class="flight-info-label">CoPilot</div><div class="flight-info-value" style="color:#a78bfa;">${toDisplay(f.coPilot)}</div></div>
                            <div><div class="flight-info-label">NIGHT</div><div class="flight-info-value" style="color:#8b5cf6;">${toDisplay(f.night)}</div></div>
                            <div><div class="flight-info-label">INST</div><div class="flight-info-value" style="color:#fbbf24;">${toDisplay(f.instTime)}</div></div>
                            <div><div class="flight-info-label">TO</div><div class="flight-info-value" style="color:#ec4899;">${f.toCount||0}</div></div>
                            <div><div class="flight-info-label">LD</div><div class="flight-info-value" style="color:#06b6d4;">${f.ldCount||0}</div></div>
                        </div>
                        ${details ? `
                            <div class="flight-details">
                                ${f.remark ? `<div class="detail-item"><strong>ğŸ’¬ ë¹„ê³ :</strong> ${f.remark}</div>` : ''}
                                ${f.wx ? `<div class="detail-item"><strong>ğŸŒ¤ï¸ ê¸°ìƒ:</strong> ${f.wx}</div>` : ''}
                                ${f.landingCmt ? `<div class="detail-item"><strong>ğŸ›¬ ì°©ë¥™:</strong> ${f.landingCmt}</div>` : ''}
                                ${f.clearance ? `<div class="detail-item"><strong>ğŸ“¡ Clearance:</strong> ${f.clearance}</div>` : ''}
                                ${f.tip ? `<div class="detail-item"><strong>ğŸ“‹ TIP:</strong> ${f.tip}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            updateStats();
        }
        
        function updateStats() {
            let block=0, pic=0, picSupv=0, coPilot=0, tr=0, night=0, inst=0, to=0, ld=0;
            flights.forEach(f => {
                block += f.blockTime || 0;
                pic += f.pic || 0;
                picSupv += f.picSupv || 0;
                coPilot += f.coPilot || 0;
                tr += f.tr || 0;
                night += f.night || 0;
                inst += f.instTime || 0;
                to += f.toCount || 0;
                ld += f.ldCount || 0;
            });
            
            document.getElementById('totalBlock').textContent = toDisplay(block);
            document.getElementById('totalPIC').textContent = toDisplay(pic + picSupv);
            document.getElementById('totalNight').textContent = toDisplay(night);
            document.getElementById('totalInst').textContent = toDisplay(inst);
            document.getElementById('totalTO').textContent = to;
            document.getElementById('totalLD').textContent = ld;
        }
        
        // í•„í„°
        function updateFilterOptions() {
            const aircrafts = [...new Set(flights.map(f => f.aircraft))].sort();
            const froms = [...new Set(flights.map(f => f.from))].sort();
            const tos = [...new Set(flights.map(f => f.to))].sort();
            
            const updateSelect = (id, items) => {
                const sel = document.getElementById(id);
                const current = sel.value;
                sel.innerHTML = '<option value="">ì „ì²´</option>' + 
                    items.map(i => `<option value="${i}">${i}</option>`).join('');
                sel.value = current;
            };
            
            updateSelect('aircraftFilter', aircrafts);
            updateSelect('fromFilter', froms);
            updateSelect('toFilter', tos);
        }
        
        function applyFiltersInternal() {
            const searchText = document.getElementById('searchText').value.toUpperCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const aircraft = document.getElementById('aircraftFilter').value;
            const from = document.getElementById('fromFilter').value;
            const to = document.getElementById('toFilter').value;
            
            let filtered = flights.filter(f => {
                if (searchText && ![f.fltNo, f.from, f.to, f.remark, f.clearance].join(' ').toUpperCase().includes(searchText)) return false;
                if (dateFrom && f.date < dateFrom) return false;
                if (dateTo && f.date > dateTo) return false;
                if (aircraft && f.aircraft !== aircraft) return false;
                if (from && f.from !== from) return false;
                if (to && f.to !== to) return false;
                return true;
            });
            
            render(filtered);
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        window.saveFirebaseConfig = function() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const projectId = document.getElementById('projectId').value.trim();
            const appId = document.getElementById('appId').value.trim();
            
            if (!apiKey || !projectId || !appId) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const config = { apiKey, projectId, appId };
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            initFirebase(config);
        };
        
        window.showFirebaseSettings = function() {
            if (confirm('Firebase ì„¤ì •ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: ë‹¤ë¥¸ ì„¤ì •ì„ ì…ë ¥í•˜ë©´ ë‹¤ë¥¸ ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì†ë©ë‹ˆë‹¤!')) {
                // í˜„ì¬ ì„¤ì • í‘œì‹œ
                const savedConfig = localStorage.getItem('firebaseConfig');
                if (savedConfig) {
                    try {
                        const config = JSON.parse(savedConfig);
                        document.getElementById('apiKey').value = config.apiKey;
                        document.getElementById('projectId').value = config.projectId;
                        document.getElementById('appId').value = config.appId;
                    } catch (e) {
                        console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
                    }
                }
                
                // ì„¤ì • íŒ¨ë„ í‘œì‹œ, ì•± í™”ë©´ ìˆ¨ê¹€
                document.getElementById('setupPanel').style.display = 'block';
                document.getElementById('app').style.display = 'none';
                document.getElementById('projectInfo').style.display = 'none';
                setSyncStatus('connecting', 'ğŸ”„ ì„¤ì • ë³€ê²½ ì¤‘...');
                
                // ìŠ¤í¬ë¡¤ ìµœìƒë‹¨ìœ¼ë¡œ
                window.scrollTo(0, 0);
            }
        };
        
        window.clearFirebaseConfig = function() {
            if (confirm('âš ï¸ Firebase ì„¤ì •ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œ í›„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì„¤ì • í™”ë©´ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.')) {
                localStorage.removeItem('firebaseConfig');
                alert('âœ… Firebase ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨(F5)í•˜ì„¸ìš”.');
            }
        };
        
        window.showAddModal = function() {
            document.getElementById('modalTitle').textContent = 'âœˆï¸ ìƒˆ ë¹„í–‰ ê¸°ë¡';
            document.getElementById('editId').value = '';
            document.getElementById('modal').classList.add('show');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        };
        
        window.showEditModal = function(id) {
            const flight = flights.find(f => f.id === id);
            if (!flight) return;
            
            document.getElementById('modalTitle').textContent = 'âœï¸ ë¹„í–‰ ê¸°ë¡ ìˆ˜ì •';
            document.getElementById('editId').value = id;
            document.getElementById('date').value = flight.date;
            document.getElementById('aircraft').value = flight.aircraft;
            document.getElementById('fltNo').value = flight.fltNo || '';
            document.getElementById('from').value = flight.from;
            document.getElementById('to').value = flight.to;
            
            const fillTime = (idPrefix, val) => {
                if (!val) return;
                const h = Math.floor(val);
                const m = Math.round((val - h) * 60);
                document.getElementById(idPrefix + 'H').value = h;
                document.getElementById(idPrefix + 'M').value = m;
            };
            
            fillTime('block', flight.blockTime);
            fillTime('pic', flight.pic);
            fillTime('picSupv', flight.picSupv);
            fillTime('coPilot', flight.coPilot);
            fillTime('tr', flight.tr);
            fillTime('night', flight.night);
            fillTime('inst', flight.instTime);
            
            document.getElementById('toCount').value = flight.toCount || '';
            document.getElementById('ldCount').value = flight.ldCount || '';
            document.getElementById('remark').value = flight.remark || '';
            document.getElementById('wx').value = flight.wx || '';
            document.getElementById('landingCmt').value = flight.landingCmt || '';
            document.getElementById('clearance').value = flight.clearance || '';
            document.getElementById('tip').value = flight.tip || '';
            
            document.getElementById('modal').classList.add('show');
        };
        
        window.closeModal = function() {
            document.getElementById('modal').classList.remove('show');
            document.querySelector('form').reset();
        };
        
        window.saveFlight = async function(e) {
            e.preventDefault();
            
            try {
                const data = {
                    date: document.getElementById('date').value,
                    aircraft: document.getElementById('aircraft').value,
                    fltNo: document.getElementById('fltNo').value,
                    from: document.getElementById('from').value.toUpperCase(),
                    to: document.getElementById('to').value.toUpperCase(),
                    blockTime: toDec(+document.getElementById('blockH').value, +document.getElementById('blockM').value),
                    pic: toDec(+document.getElementById('picH').value, +document.getElementById('picM').value),
                    picSupv: toDec(+document.getElementById('picSupvH').value, +document.getElementById('picSupvM').value),
                    coPilot: toDec(+document.getElementById('coPilotH').value, +document.getElementById('coPilotM').value),
                    tr: toDec(+document.getElementById('trH').value, +document.getElementById('trM').value),
                    night: toDec(+document.getElementById('nightH').value, +document.getElementById('nightM').value),
                    instTime: toDec(+document.getElementById('instH').value, +document.getElementById('instM').value),
                    toCount: +document.getElementById('toCount').value || 0,
                    ldCount: +document.getElementById('ldCount').value || 0,
                    remark: document.getElementById('remark').value,
                    wx: document.getElementById('wx').value,
                    landingCmt: document.getElementById('landingCmt').value,
                    clearance: document.getElementById('clearance').value,
                    tip: document.getElementById('tip').value
                };
                
                const editId = document.getElementById('editId').value;
                data.id = editId || `flight_${Date.now()}`;
                
                await saveFlightToFirebase(data);
                window.closeModal();
                
            } catch (error) {
                console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        };
        
        window.deleteFlightHandler = async function(id) {
            if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await deleteFlightFromFirebase(id);
                } catch (error) {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                }
            }
        };
        
        window.applyFilters = function() {
            applyFiltersInternal();
        };
        
        window.clearFilters = function() {
            document.getElementById('searchText').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('aircraftFilter').value = '';
            document.getElementById('fromFilter').value = '';
            document.getElementById('toFilter').value = '';
            applyFiltersInternal();
        };
        
        window.importExcel = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (typeof XLSX === 'undefined') {
                alert('Excel ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                return;
            }
            
            console.log('ğŸ“¤ Excel ê°€ì ¸ì˜¤ê¸°:', file.name);
            console.log('=== ìƒˆ Excel êµ¬ì¡° (LOG_2026-02-26.xlsx) ===');
            console.log('A: Date, B: Aircraft, C: FLT_NO, D: From, E: To');
            console.log('F: BLOCK, G: PIC, H: PIC_Supv, I: CoPilot, J: TR');
            console.log('K: NIGHT, L: INST, M: TO, N: LD');
            console.log('O: Remark, P: Wx, Q: Landing, R: Clearance, S: TIP');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    
                    console.log('âœ… Excel ë¡œë“œ ì™„ë£Œ');
                    
                    // Row 2ë¶€í„° ì‹œì‘ (Row 1ì€ í—¤ë”)
                    let imported = 0;
                    for (let row = 2; row <= 200; row++) {
                        const cellA = ws[`A${row}`];
                        const cellB = ws[`B${row}`];
                        
                        if (!cellA || !cellB) break;
                        
                        const dateStr = (cellA.w || cellA.v || '').toString();
                        if (dateStr.includes('Total') || !dateStr) break;
                        
                        // ë‚ ì§œ íŒŒì‹± (1/4/26 â†’ 2026-01-04)
                        let formattedDate = dateStr;
                        const dateMatch = dateStr.match(/(\d+)\/(\d+)\/(\d+)/);
                        if (dateMatch) {
                            const month = dateMatch[1].padStart(2, '0');
                            const day = dateMatch[2].padStart(2, '0');
                            const year = '20' + dateMatch[3];
                            formattedDate = `${year}-${month}-${day}`;
                        }
                        
                        const flightData = {
                            id: `flight_${Date.now()}_${row}`,
                            date: formattedDate,
                            aircraft: (ws[`B${row}`]?.w || ws[`B${row}`]?.v || '').toString(),
                            fltNo: (ws[`C${row}`]?.w || ws[`C${row}`]?.v || '').toString(),
                            from: (ws[`D${row}`]?.w || ws[`D${row}`]?.v || '').toString(),
                            to: (ws[`E${row}`]?.w || ws[`E${row}`]?.v || '').toString(),
                            blockTime: parseTimeString(ws[`F${row}`]?.w || ws[`F${row}`]?.v),
                            pic: parseTimeString(ws[`G${row}`]?.w || ws[`G${row}`]?.v),
                            picSupv: parseTimeString(ws[`H${row}`]?.w || ws[`H${row}`]?.v),
                            coPilot: parseTimeString(ws[`I${row}`]?.w || ws[`I${row}`]?.v),
                            tr: parseTimeString(ws[`J${row}`]?.w || ws[`J${row}`]?.v),
                            night: parseTimeString(ws[`K${row}`]?.w || ws[`K${row}`]?.v),
                            instTime: parseTimeString(ws[`L${row}`]?.w || ws[`L${row}`]?.v),
                            toCount: parseInt(ws[`M${row}`]?.v || 0),
                            ldCount: parseInt(ws[`N${row}`]?.v || 0),
                            remark: (ws[`O${row}`]?.w || ws[`O${row}`]?.v || '').toString(),
                            wx: (ws[`P${row}`]?.w || ws[`P${row}`]?.v || '').toString(),
                            landingCmt: (ws[`Q${row}`]?.w || ws[`Q${row}`]?.v || '').toString(),
                            clearance: (ws[`R${row}`]?.w || ws[`R${row}`]?.v || '').toString(),
                            tip: (ws[`S${row}`]?.w || ws[`S${row}`]?.v || '').toString()
                        };
                        
                        if (imported < 3) {
                            console.log(`Row ${row}:`, flightData);
                        }
                        
                        await saveFlightToFirebase(flightData);
                        imported++;
                    }
                    
                    console.log(`âœ… ${imported}ê°œ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`);
                    
                    // í†µê³„ ê³„ì‚°
                    const totalBlock = flights.reduce((sum, f) => sum + (f.blockTime || 0), 0);
                    const totalPIC = flights.reduce((sum, f) => sum + (f.pic || 0) + (f.picSupv || 0), 0);
                    const totalNight = flights.reduce((sum, f) => sum + (f.night || 0), 0);
                    const totalInst = flights.reduce((sum, f) => sum + (f.instTime || 0), 0);
                    
                    alert(`âœ… ${imported}ê°œ ë¹„í–‰ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!\n\ní†µê³„:\n- Total Block: ${toDisplay(totalBlock)}\n- Total PIC: ${toDisplay(totalPIC)}\n- Night: ${toDisplay(totalNight)}\n- Inst: ${toDisplay(totalInst)}\n\në‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ í™•ì¸í•´ë³´ì„¸ìš”!`);
                    
                } catch (err) {
                    console.error('âŒ Excel ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', err);
                    alert('Excel ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:\n' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };
        
        window.exportExcel = function() {
            if (typeof XLSX === 'undefined') {
                alert('Excel ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
                return;
            }
            
            try {
                const wb = XLSX.utils.book_new();
                const data = [
                    ['Date', 'Aircraft', 'FLT_NO', 'From', 'To', 'BLOCK', 'PIC', 'PIC_Supv', 'CoPilot', 'TR', 'NIGHT', 'INST', 'TO', 'LD', 'Remark', 'Wx', 'Landing', 'Clearance', 'TIP']
                ];
                flights.forEach(f => {
                    data.push([
                        f.date, f.aircraft, f.fltNo || '', f.from, f.to,
                        toDisplay(f.blockTime), toDisplay(f.pic), toDisplay(f.picSupv),
                        toDisplay(f.coPilot), toDisplay(f.tr), toDisplay(f.night), toDisplay(f.instTime),
                        f.toCount, f.ldCount, f.remark, f.wx, f.landingCmt, f.clearance, f.tip
                    ]);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Log');
                const filename = `LOG_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                console.log('âœ… Excel ë‚´ë³´ë‚´ê¸° ì™„ë£Œ:', filename);
            } catch (e) {
                console.error('âŒ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', e);
                alert('ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: ' + e.message);
            }
        };
        
        window.resetAll = async function() {
            if (!confirm('âš ï¸ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            if (!confirm('ì •ë§ í™•ì‹¤í•©ë‹ˆê¹Œ?')) return;
            
            try {
                setSyncStatus('connecting', 'ğŸ”„ ì‚­ì œ ì¤‘...');
                
                const flightsRef = collection(db, 'users', userId, 'flights');
                const snapshot = await getDocs(flightsRef);
                
                const deletePromises = [];
                snapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                
                flights = [];
                applyFiltersInternal();
                
                setSyncStatus('connected', 'â˜ï¸ í´ë¼ìš°ë“œ ì—°ê²°ë¨');
                alert('âœ… ì „ì²´ ë¦¬ì…‹ ì™„ë£Œ!');
                
            } catch (error) {
                console.error('âŒ ë¦¬ì…‹ ì‹¤íŒ¨:', error);
                alert('ë¦¬ì…‹ ì‹¤íŒ¨: ' + error.message);
            }
        };
        
        // ì €ì¥ëœ ì„¤ì • í™•ì¸
        const savedConfig = localStorage.getItem('firebaseConfig');
        if (savedConfig) {
            try {
                const config = JSON.parse(savedConfig);
                console.log('ì €ì¥ëœ Firebase ì„¤ì • ë°œê²¬');
                
                document.getElementById('apiKey').value = config.apiKey;
                document.getElementById('projectId').value = config.projectId;
                document.getElementById('appId').value = config.appId;
                
                initFirebase(config);
            } catch (e) {
                console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }
    </script>
</body>
</html>
